# GalGameCG
这是一个GalGame的合成软件，主要包含自动、手动的CG、差分合成等
https://www.bilibili.com/opus/1150951768201363491

CG合成：
cut-off
1.拆包
.pimg文件为部分KRKR引擎的GalGame对CG的封包处理，解包后得到pimg文件，提取CG也很简单，只需要使用FreeMote的PsbDecompile解包即可。

下载链接：https://github.com/UlyssesWu/FreeMote/releases

下载完后解压，在根目录找到PsbDecompile.exe，直接把需要解包的pimg文件拖动到exe上就能解包了。

解包后在原本的pimg文件根目录会多出来几个文件：以pimg文件命名的文件夹、.json文件、.resx.json文件，其中文件夹内放着的就是解包后的图片文件，.json文件就是我们合成CG需要的坐标文件，.resx.json文件可以直接删除（如果需要重新封包的话不要删）。

cut-off
2.合成
目前有很多的CG自动程序，这里就不一一列举了，具体教程可以在B站搜索。也可以下载我的合成程序使用。

下载链接：https://github.com/ex55kk/GalGameCG




点击下载exe文件，打开后点击左上角的工具，点击坐标差分自动合成。

cut-off
工具中主要有以下内容：

差分手动合成（不常用）：用于手动调节差分的X\Y坐标去合成差分，主要用于人物差分的坐标文件被加密（如妹抱）或者无法获得人物差分文件的情况。

固定差分自动合成（不常用）：用于某些游戏（Unity，比如苍之彼方四重奏）的CG合成，需要用到解包出来的csv文件，里面包含每个CG对应的差分。其他的我不知道，苍之彼方四重奏的CG差分都是在固定坐标的，直接重叠就能合成

分解差分半自动合成（不常用）：同样用于Unity等，同于人物差分合成，这些人物差分全部都在一个大差分图片内，需要手动进行差分分割进行合成。因为需要实时进行切割渲染，所以这个工具在放大调整差分位置的时候会非常卡，暂时没有解决方法，除非在合成前先提前把差分给切割了然后用别的工具合成差分，但因为这种差分极其少见就不在这里列举方法了

坐标差分自动合成：主要用于多数pimg文件的CG合成

坐标差分半自动合成（半完成状态）：主要用于人物差分合成，目前仅支持某些差分解包后，坐标文件为txt格式的。

合成CG的话，直接到坐标差分自动合成页面，然后点击左上角的添加坐标文件，将刚才拆包得到的.json文件全部添加，最后点击右下角的开始自动合成即可合成。


合成原理我放到最后讲。

cut-off
差分合成：
差分合成这里内容比较麻烦，主要倾向于合成全部组合的差分，嫌麻烦的可以跳过，直接使用其他的差分合成软件合成。

坐标差分合成页面主要如下：


中间一览从左往右分别为：
输出日志、预览、列表区

下方一览从左往右分别为：
导出格式、导出全部坐标文件、导出当前页面、导出当前背景

上方一览从左往右分别为：
添加坐标文件按钮：

在这里添加你的差分坐标TXT文件，添加前请确保你的差分格式如下：


*如果格式是这样但文件类型不是TXT也可以手动更改后缀。




*如果文件打开是这样那么可以尝试更改编码，或者直接添加到程序。

可以一次添加多个，添加后页面左下角会出现列表

添加后会默认选中最后添加的一个


正常添加后开始差分设置 ↓

差分设置按钮：




我们先在坐标列表中找到人物差分的背景图片，然后选择这些背景图片，将右边的“类型”改为背景，并确保上方的开启勾选框为勾选状态。（取消勾选后这个差分在合成中就会自动跳过） ↓


*添加后在主页面右侧列表的背景列表显示

接下来开始配置差分，像下面这种眼睛眉毛嘴巴的差分我们就直接默认会设置为差分，无需配置下方的选项。（程序会自动根据差分名称配置附加差分和背景差分，请仔细检查是否有错误把普通差分下面的勾选框勾选） ↓


有时候会出现类似空白内容的差分，这种情况程序无法自动识别，需要自行将该差分配置区域上方的开启勾选框取消勾选。


接下来配置背景差分，我们找到像这样子只有部分头发的差分，将这些差分的背景差分勾选框勾选，这些差分作为头发修复差分，避免背景和差分合成后，眼睛将头发挡住，背景差分通过再附加一层到最外层，并且通过调整透明度完善最终的差分。


*左图为头发修复，右图未头发修复


选中背景差分后可以点击下方按钮对其进行配置，一般情况下无需进行设置。

配置适用对象，则该背景差分仅适用于选中的差分或者背景，若选中差分，则背景差分仅在合成到选中差分时会叠加这个背景差分，若选中背景，则背景差分会在合成该背景时一直叠加，合成别的背景时不进行叠加。（一般差分的惊讶、恐惧差分会有降低面部亮度的背景差分，或者不同的背景有对应不同的头发修复差分，则可以选择适用对象）  ↓




比如小绫的背景有刀服用和正常的两张头发差分，若两个差分全部选择背景差分并且不进行配置的话，导出时就会使这两个背景差分叠加在一起导出，所以需要进行配置。选择刀服用的背景差分，设置差分中找到名称为刀服的背景，然后勾选并且确定，再选择正常背景差分，将除了刀服以外的其他背景勾选。这样导出刀服背景时会使用特定的背景差分，导出正常背景时使用正常背景差分。 ↓


在背景差分设置中的最上方还有一个单独背景差分勾选框，与适用对象相反，勾选单独背景差分后，会在导出时导出多份（一共有多少个背景差分单独背景差分就会导出多少份），每一份都是单独以一个背景差分叠加后导出。比如选择了A、B两个差分作为单独背景差分，导出时就会先以只有A差分作为背景差分的情况导出，然后再以只有B差分作为背景差分的情况导出，但一般情况下不常用。（单独背景差分和适用对象同时有效）

接下来配置附加差分，选中附加差分勾选框后，会出现附加后缀，设置的内容为导出时附加差分的图片添加的后缀。

附加差分一般为頬染（俗称：脸红）、流汗的差分，所以导出时我们需要先导出一遍不带附加差分的原版差分，然后再导出一遍带附加差分的差分。


在附加差分的差分设置页面，和背景差分相似，都有单独附加差分和适用对象。

适用对象选择后，该附加差分只会在导出到选择的对象时再重新导出一遍带上附加差分的图片。

选择单独附加差分后，导出时每个附加差分只会单独导出，不会进行配对导出。配对导出逻辑如下：

假设现在有A、B两个附加差分，那么导出时会先导出原差分，然后导出加上A附加差分的，再导出带上B附加差分的，最后导出A、B附加差分一起覆盖的。也就是说导出为：RAW、A、B、AB，那么假设有A、B、C三个附加差分，则导出为：RAW、A、B、C、AB、AC、BC、ABC。

如果每个附加差分都选择了单独附加差分的话，那么假设A、B两个附加差分，导出就是：RAW、A、B，假设三个A、B、C，那么导出就是：RAW、A、B、C。

所以附加差分最好选上单独附加差分，程序为防止叠加太多，超过4个附加差分未选择单独附加差分时，就会自动把全部附加差分当作单独附加差分导出。

现在配置好差分设置了，点击关闭回到主页面，在右侧列表选中一个背景和差分，就可以在中间显示导出时的预览了。在TXT内的分辨率是给游戏用的，我们导出时不需要那么大的画布，会极大影响导出速度，我们可以通过上方画布分辨率修改导出画布，确保画布将人物差分包裹即可。

在右侧附加差分列表选中附加差分后，点击上方预览附加差分勾选框即可在预览界面预览添加上附加差分的预览图像。


在设置完全部TXT后，点击右下角导出全部坐标文件即可将全部TXT的所有差分导出，导出当前页面按钮为导出当前选中的TXT的全部背景的差分，导出当前背景就是导出当前选中的背景的差分。

导出后就可以在和TXT文件相同目录下的output文件夹内找到导出的差分，导出的目录和格式都可以通过下方三个格式输入框修改，可以根据变量提示自行修改。li

另外，左上方重置按钮点击后会将整个页面包括设置的内容全部清空，导出时点击重置按钮可以停止导出。

cut-off
最后，这款程序由ChatGPT辅助制作，有些许地方可能有BUG请见谅。接下来是CG的合成原理。↓

CG合成原理：
目前pimg文件的json坐标文件格式有两种（我只发现两种:D）：

第一种：Name分组

格式如下：


在最外层有height和weight两项，这个就是导出时的画布大小了。

在layers项中有多个项，每个项对应一个图片文件，CG有多个背景图片，通过每一项的name去分组，每一组的a项为背景图片，比如Aa、Ba，分辨率都和画布大小相同，那么在A组中的其余项（比如Ab、Ac）都为该背景对应的差分。

每一项中还有其余项，具体作用如下：

height:差分图像的Y分辨率

width:差分图像的X分辨率

layer_id:对应差分图像名称

left:差分图像在背景的X位移

top:差分图像在背景的Y位移

opacity:差分图像在背景的可见度

只需要程序根据这个逻辑去合成CG即可。



第二种：Diff分组

格式如下：



现在和Name分组不一样的地方为，不再以name的名称分组，差分的命名均以A-G的两个大写字母按顺序命名。

背景图片仍然为和画布大小一样的项，程序的检测方式为，直接检测项中不带有diff_id的项，并且检测分辨率是否和画布相同。

差分图片则为项中带有diff_id的项，这里的diff_id的数值就是对应的背景图片的layer_id，也就是背景图片的图片名称。

通过以上逻辑即可合成CG。
